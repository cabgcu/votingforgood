<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Lip Sync 2025 Voting</title>

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<!-- Tailwind -->
<script defer src="https://cdn.tailwindcss.com"></script>
<script>
document.fonts.ready.then(()=>document.documentElement.classList.add('fonts-loaded'));
</script>

<!-- FingerprintJS -->
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs/dist/fp.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
html{opacity:0;transition:opacity .3s ease-in;font-size:clamp(14px,2vw,17px);}
html.fonts-loaded{opacity:1}
body{margin:0;min-height:100%;font-family:'Inter',sans-serif;color:white;background:black;
  -webkit-user-select:none;touch-action:manipulation;overflow-x:hidden;}
#bg-video{position:fixed;top:0;left:0;width:100vw;height:100vh;object-fit:cover;z-index:0;opacity:.8;}
.screen{position:relative;min-height:100vh;display:flex;align-items:center;justify-content:center;
  flex-direction:column;padding:2rem 1rem;z-index:10;transition:opacity .3s ease;}
.hidden{opacity:0!important;pointer-events:none;}
#voting-screen{overflow-y:auto;-webkit-overflow-scrolling:touch;}
.glass-card{background:rgba(0,0,0,.45);backdrop-filter:blur(20px);border-radius:1.25rem;
  border:1px solid rgba(255,255,255,.15);width:100%;max-width:420px;overflow:hidden;}
@keyframes pink-green-glow{
  0%{box-shadow:0 0 10px 1px rgba(255,105,180,.6);}
  50%{box-shadow:0 0 18px 3px rgba(96,163,77,.8);}
  100%{box-shadow:0 0 10px 1px rgba(255,105,180,.6);}
}
button.glow{animation:pink-green-glow 6s ease-in-out infinite;}
.performer-card.selected{border:2px solid #22c55e;box-shadow:0 0 20px 3px rgba(34,197,94,.5);}
#submit-vote-btn.ready{background:#22c55e!important;color:black!important;border:none!important;
  box-shadow:0 0 10px 2px rgba(34,197,94,.6);transition:all .3s ease;}
.vertical-image{width:100%;height:auto;border-radius:0.75rem;}
</style>
</head>

<body>
<video autoplay muted playsinline loop preload="auto" id="bg-video"
  poster="https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/EnuWGLA%20-%20Imgur.png?alt=media&token=c06a0ce1-d2e3-4cde-ac4a-a5ba89142b30">
  <source src="https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/mAzP2S1%20-%20Imgur.mp4?alt=media&token=dc264640-a95e-4494-9d27-83ab5380a1a6" type="video/mp4">
</video>

<!-- LOGIN -->
<div id="login-screen" class="screen">
  <div class="glass-card flex flex-col items-center text-center p-6 w-11/12 max-w-md shadow-2xl my-4">
    <img class="w-full max-w-[240px] mb-4" src="https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/EnuWGLA%20-%20Imgur.png?alt=media&token=c06a0ce1-d2e3-4cde-ac4a-a5ba89142b30" alt="Lip Sync Header">
    <div id="login-options" class="w-full flex-1">
      <div id="student-id-mode">
        <p id="student-id-error" class="text-white/70 text-base mb-6">Enter your Student ID to vote.</p>
        <input type="number" id="student-id-input" placeholder="Enter Student ID"
          class="w-full p-3 rounded-lg bg-white/10 text-white border border-white/30 text-center mb-3 text-base"/>
        <button id="student-id-btn"
          class="glow w-full p-3 text-base text-white rounded-lg border border-white/50 shadow-lg transition mb-4">
          Begin Voting
        </button>
        <a href="#" id="show-location-mode"
           class="block text-sm text-white/60 underline mt-2 mb-4 py-2 hover:text-white/90">
          No Student ID? Click Here!
        </a>
      </div>

      <!-- LOCATION MODE -->
      <div id="location-mode" class="hidden">
        <p id="location-error" class="text-white/70 text-base mb-6">
          Location access is required to vote. You can vote while inside the GCU Arena!
        </p>
        <button id="location-btn"
          class="glow w-auto min-w-[180px] px-8 py-3 text-base text-white rounded-xl
          border border-white/50 shadow-lg transition mb-2">Begin Voting</button>
        <a id="retry-location"
           class="block text-sm text-white/70 underline mb-5 hover:text-white/90 hidden" href="#">
           Try Again
        </a>
        <a href="#" id="show-id-mode"
           class="block text-sm text-white/60 underline mt-2 mb-4 py-2 hover:text-white/90">
          Vote with Student ID instead.
        </a>
      </div>
    </div>
    <footer class="pt-6 text-white/70 text-sm flex flex-col items-center max-w-sm mt-4 mb-2">
      <img src="https://ik.imagekit.io/cabgcu/Untitled%20design-3.png" alt="CAB Logo"
        class="h-10 mb-2 object-contain" onerror="this.style.display='none'">
      <p>Follow Us At <b>@CABGCU</b> On Instagram</p>
    </footer>
  </div>
</div>

<!-- VOTING -->
<div id="voting-screen" class="screen hidden">
  <div class="glass-card w-full max-w-md p-5 text-center shadow-2xl flex flex-col my-8">
    <img class="w-full max-w-[180px] mx-auto mb-3" src="https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/EnuWGLA%20-%20Imgur.png?alt=media&token=c06a0ce1-d2e3-4cde-ac4a-a5ba89142b30" alt="Header">
    <h3 id="voting-header" class="text-xl font-semibold mb-2">Vote For Your Favorite Lip Sync Team!</h3>
    <p id="voting-subtext" class="text-white/70 text-sm mb-3">
      Each attendee may submit only one vote per device or Student ID.
    </p>
    <div id="performers-container"
         class="space-y-3 flex-1 min-h-[40vh] max-h-[55vh] overflow-y-auto -mr-1 pr-2
         scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent rounded-xl"></div>
    <button id="submit-vote-btn"
      class="mt-5 w-full py-3 px-6 text-base bg-black border border-white/50 text-white rounded-xl
      transition disabled:opacity-40" disabled>Select a Performer to Vote</button>
  </div>
</div>

<!-- CONFIRMATION -->
<div id="confirmation-screen" class="screen hidden">
  <div class="glass-card w-11/12 max-w-sm rounded-3xl p-6 text-center shadow-2xl">
    <h3 class="text-2xl font-bold mb-3 text-white">✅ Submission Received!</h3>
    <img id="confirmation-image" class="w-full max-w-[240px] mx-auto rounded-xl mb-4" alt="Team Image">
    <p id="confirmation-message" class="text-white text-base mb-4"></p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";

const firebaseConfig = {
  apiKey: "AIzaSyBoYf1_IhILJ96Y9KMcwrVjHMFLT5YEKuQ",
  authDomain: "lip-sync-2025.firebaseapp.com",
  projectId: "lip-sync-2025",
  storageBucket: "lip-sync-2025.appspot.com",
  messagingSenderId: "118581305479",
  appId: "1:118581305479:web:7a7335c1be6e816cc7d822",
  measurementId: "G-NQ0GMG05Q2"
};

let db, auth, userId, deviceHash = null;
let selectedVoteId = null, selectedVoteName = "", selectedVoteImage = "";
let appInitialized = false, votingEnabled = true, authMethod = null, verifiedStudentId = null;

const performerData = {
  option1: { name: "Below", img: "https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/DIyK2zX%20-%20Imgur.jpg?alt=media&token=556535f9-b60c-4fd7-a365-e9cef3f78ecd" },
  option2: { name: "Deliverance", img: "https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/s7Unz9r%20-%20Imgur.jpg?alt=media&token=c8479380-c66d-4778-9ba2-36eb161a84de" },
  option3: { name: "Mask Off", img: "https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/x0BI8Mc%20-%20Imgur.jpg?alt=media&token=f2d1ab93-aa73-412e-b00e-a1cdef71d9ee" },
  option4: { name: "Metro Motion", img: "https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/4rG47gL%20-%20Imgur.jpg?alt=media&token=1262b438-78f8-4ca4-ba6e-69cb35a8edad" },
  option5: { name: "Sin Game", img: "https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/k75mMUz%20-%20Imgur.jpg?alt=media&token=577a7b48-68e6-4171-ac7d-531ee35b850e" },
  option6: { name: "Anonymity", img: "https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/3dJQFeX%20-%20Imgur.jpg?alt=media&token=dd2e317e-ac13-47eb-bd15-97f8491d4fc2" }
};

const closedImage = "https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/kWKvSbS%20-%20Imgur.jpg?alt=media&token=f0e1f6a7-ddc9-46e1-9cef-7268031136c3";

document.addEventListener("DOMContentLoaded",()=>initializeFirebase());

async function initializeFirebase(){
  const app = initializeApp(firebaseConfig);
  initializeAppCheck(app,{provider:new ReCaptchaV3Provider('6LdIDf8rAAAAAN29EDUYVkddlpw3QQy9ImSPFpm1'),isTokenAutoRefreshEnabled:true});
  db = getFirestore(app); auth = getAuth(app);
  initializeAppLogic();
}

async function generateDeviceHash(){
  const fp = await FingerprintJS.load(); const r = await fp.get();
  const traits = [navigator.userAgent,navigator.language,screen.width,screen.height,
    navigator.hardwareConcurrency,Intl.DateTimeFormat().resolvedOptions().timeZone,
    r.components.platform?.value||"",r.components.vendor?.value||""].join("|");
  const buf = await crypto.subtle.digest("SHA-256",new TextEncoder().encode(traits));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

function setScreen(id){document.querySelectorAll(".screen").forEach(el=>el.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");}
function isInsideGeofence(lat,long){return geofences.some(g=>lat>=g.minLat&&lat<=g.maxLat&&long>=g.minLong&&long<=g.maxLong);}
function showError(msg,type='location'){const el=(type==='location')?document.getElementById("location-error"):document.getElementById("student-id-error");if(!el)return;el.textContent=msg;el.classList.add("text-red-400","font-bold");}

const geofences = [
  {minLat:33.508268,maxLat:33.511748,minLong:-112.130755,maxLong:-112.126984},
  {minLat:33.512279,maxLat:33.512623,minLong:-112.130699,maxLong:-112.130440},
  {minLat:33.6786695,maxLat:33.6789695,minLong:-112.256548,maxLong:-112.256248}
];

function handleLocationCheck(){
  if (!navigator.geolocation) return showError("Location not supported on this device.");
  const errEl=document.getElementById("location-error");
  errEl.classList.remove("text-red-400","font-bold");
  errEl.textContent="Checking your location...";
  navigator.geolocation.getCurrentPosition(
    pos=>{
      const{latitude,longitude}=pos.coords;
      if(isInsideGeofence(latitude,longitude)){
        sessionStorage.setItem("locationVerified","true");
        authMethod='location';
        setScreen("voting-screen");
      }else showError("You must be at the GCU Arena to vote!");
    },
    err=>{
      const retry=document.getElementById("retry-location");
      retry.classList.remove("hidden");
      if(err.code===1){
        showError("Location access is blocked. Go to Settings → Safari or Chrome → Location → Allow or Ask Next Time.","location");
      }else{
        showError("Location access is needed to vote. Please refresh!");
      }
    },
    {timeout:10000,enableHighAccuracy:true}
  );
}

async function handleStudentIdCheck(){
  const id=document.getElementById("student-id-input").value;
  if(!id)return showError("Please enter a Student ID.","student_id");
  const btn=document.getElementById("student-id-btn");
  btn.disabled=true;
  const r=doc(db,"student_ids",id);const s=await getDoc(r);
  if(!s.exists())showError("Student ID not found.","student_id");
  else if(s.data().hasVoted)showError("This Student ID has already voted.","student_id");
  else{authMethod="student_id";verifiedStudentId=id;setScreen("voting-screen");}
  setTimeout(()=>btn.disabled=false,1500);
}

function handleCardSelection(e){
  const c=e.target.closest(".performer-card");if(!c)return;
  document.querySelectorAll(".performer-card").forEach(x=>x.classList.remove("selected"));
  c.classList.add("selected");
  selectedVoteId=c.dataset.voteId;
  selectedVoteName=performerData[selectedVoteId].name;
  selectedVoteImage=performerData[selectedVoteId].img;
  const b=document.getElementById("submit-vote-btn");
  b.disabled=false;b.textContent=`Submit Vote for ${selectedVoteName}`;b.classList.add("ready");
}

async function submitVote(voteId,btn){
  if(!deviceHash||!userId)return;
  if(!votingEnabled){showError("Voting is closed!");return;}
  btn.disabled=true;btn.textContent="Submitting...";
  try{
    const vRef=doc(db,"lip_sync_2025_votes",userId);
    const fRef=doc(db,"voted_fingerprints",deviceHash);
    const data={
      voteId,
      createdAt:Date.now(),
      userId,
      deviceHash,
      authMethod,
      verifiedStudentId: verifiedStudentId || null,
      userAgent:navigator.userAgent
    };
    await runTransaction(db,async t=>{
      const fp=t.get(fRef);
      if((await fp).exists())throw new Error(`VOTED_ALREADY:${(await fp).data().voteId}`);
      t.set(vRef,data);
      t.set(fRef,{createdAt:data.createdAt,userId,voteId});
      if(verifiedStudentId){
        const sidRef = doc(db,"student_ids",verifiedStudentId);
        t.update(sidRef,{hasVoted:true});
      }
    });
    showConfirmation(selectedVoteId);
  }catch(e){
    if(e.message.includes("VOTED_ALREADY:")){
      showConfirmation(e.message.split(":")[1]);
    }else showError("Error submitting vote. Please refresh.");
  }
}

function showConfirmation(voteId){
  const team=performerData[voteId];
  document.getElementById("confirmation-image").src=team.img;
  document.getElementById("confirmation-message").innerHTML=`Your vote for <b>${team.name}</b> has been recorded.<br><br>Thank you for attending <b>Lip Sync: For Good!</b>`;
  setScreen("confirmation-screen");
}

async function checkExistingVote(){
  if(!deviceHash||!userId)return false;
  const fRef=doc(db,"voted_fingerprints",deviceHash);
  const vRef=doc(db,"lip_sync_2025_votes",userId);
  const fDoc=await getDoc(fRef);
  const vDoc=await getDoc(vRef);
  if(fDoc.exists()){showConfirmation(fDoc.data().voteId);return true;}
  if(vDoc.exists()){showConfirmation(vDoc.data().voteId);return true;}
  return false;
}

async function initializeAppLogic(){
  if(appInitialized)return;appInitialized=true;
  document.getElementById("location-btn").addEventListener("click",handleLocationCheck);
  document.getElementById("retry-location").addEventListener("click",()=>location.reload());
  document.getElementById("student-id-btn").addEventListener("click",handleStudentIdCheck);
  document.getElementById("show-id-mode").addEventListener("click",e=>{e.preventDefault();
    document.getElementById("location-mode").classList.add("hidden");
    document.getElementById("student-id-mode").classList.remove("hidden");});
  document.getElementById("show-location-mode").addEventListener("click",e=>{e.preventDefault();
    document.getElementById("student-id-mode").classList.add("hidden");
    document.getElementById("location-mode").classList.remove("hidden");});
  document.getElementById("performers-container").addEventListener("click",handleCardSelection);
  document.getElementById("submit-vote-btn").addEventListener("click",()=>submitVote(selectedVoteId,document.getElementById("submit-vote-btn")));

  try{deviceHash=await generateDeviceHash();}catch{showError("Unable to verify device identity.");}

  onAuthStateChanged(auth,async(u)=>{
    if(u){
      userId=u.uid;
      const sRef=doc(db,"lip_sync_2025_settings","state");
      onSnapshot(sRef,async(s)=>{
        if(!s.exists())return;
        votingEnabled=s.data().enabled;
        const header=document.getElementById("voting-header");
        const sub=document.getElementById("voting-subtext");
        const btn=document.getElementById("submit-vote-btn");
        const container=document.getElementById("performers-container");

        if(!votingEnabled){
          setScreen("voting-screen");
          header.textContent="Voting Is Now Closed!";
          sub.textContent="Thank you for joining Lip Sync: For Good!";
          container.innerHTML=`<div class='p-2'><img src='${closedImage}' class='vertical-image mx-auto' alt='Voting Closed'></div>`;
          btn.disabled=true;btn.textContent="Voting Closed";
          return;
        }

        header.textContent="Vote For Your Favorite Lip Sync Team!";
        sub.textContent="Each attendee may submit only one vote per device or Student ID.";
        container.innerHTML=Object.entries(performerData).map(([id,{name,img}])=>
          `<div class='performer-card bg-white/5 border border-white/10 p-4 rounded-xl cursor-pointer' data-vote-id='${id}'>
             <img src='${img}' class='w-full aspect-video object-cover rounded-lg mb-2' alt='${name}'>
             <h4 class='text-lg font-semibold'>${name}</h4>
           </div>`).join('');
        btn.disabled=true;btn.textContent="Select a Performer to Vote";

        const alreadyVoted=await checkExistingVote();
        if(!alreadyVoted)setScreen("login-screen");
      });
    }else await signInAnonymously(auth);
  });
}
</script>
</body>
</html>
