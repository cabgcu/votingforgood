<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Lip Sync 2025 Voting</title>

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<!-- Tailwind -->
<script defer src="https://cdn.tailwindcss.com"></script>
<script>
document.fonts.ready.then(()=>document.documentElement.classList.add('fonts-loaded'));
</script>

<!-- FingerprintJS -->
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs/dist/fp.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
html { opacity: 0; transition: opacity .3s ease-in; font-size: clamp(14px,2vw,17px); }
html.fonts-loaded { opacity: 1; }

body {
  margin: 0; min-height: 100%;
  font-family: 'Inter', sans-serif;
  color: white; background: black;
  -webkit-user-select: none;
  touch-action: manipulation;
  overflow-x: hidden;
}

#bg-video {
  position: fixed; top:0; left:0;
  width:100vw; height:100vh;
  object-fit:cover;
  z-index:0; opacity:0.8;
}

/* Screen */
.screen {
  position: fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  padding:1rem; z-index:10;
  transition:opacity .3s ease;
}
.hidden { opacity:0!important; pointer-events:none; }

/* Glass card */
.glass-card {
  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(20px);
  border-radius:1.25rem;
  border:1px solid rgba(255,255,255,0.15);
  width:100%;
  max-width:420px;
  overflow:hidden;
}

/* Glow */
@keyframes pink-green-glow {
  0%{box-shadow:0 0 10px 1px rgba(255,105,180,0.6);}
  50%{box-shadow:0 0 18px 3px rgba(96,163,77,0.8);}
  100%{box-shadow:0 0 10px 1px rgba(255,105,180,0.6);}
}
button.glow { animation:pink-green-glow 6s ease-in-out infinite; }

.performer-card.selected {
  border:2px solid #22c55e;
  box-shadow:0 0 20px 3px rgba(34,197,94,0.5);
}

#submit-vote-btn.ready {
  background:#22c55e!important;
  color:black!important;
  border:none!important;
  box-shadow:0 0 10px 2px rgba(34,197,94,0.6);
  transition:all .3s ease;
}

/* Spinner */
.spinner {
  border:3px solid rgba(255,255,255,0.15);
  border-top-color:#fff;
  border-radius:50%;
  width:22px;height:22px;
  animation:spin .9s linear infinite;
  margin:0 auto;
}
@keyframes spin { to{transform:rotate(360deg);} }

/* Voting screen scroll */
#voting-screen .glass-card {
  display:flex;
  flex-direction:column;
  max-height:90vh;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding-bottom:1rem;
}
#performers-container {
  flex:1;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding-right:4px;
  margin-right:-4px;
  scrollbar-width:thin;
  scrollbar-color:rgba(255,255,255,0.2) transparent;
}

@media (max-height:750px){
  #voting-screen .glass-card {max-height:none;height:auto;}
}

@media (prefers-reduced-motion:reduce){
  *{animation:none!important;transition:none!important;}
}
</style>
</head>

<body>
<video autoplay muted playsinline loop preload="auto" id="bg-video" poster="https://i.imgur.com/EnuWGLA.png">
  <source src="https://i.imgur.com/mAzP2S1.mp4" type="video/mp4">
</video>

<!-- LOGIN -->
<div id="login-screen" class="screen">
  <div class="glass-card flex flex-col items-center text-center p-6 w-11/12 max-w-md shadow-2xl my-4">
    <img class="w-full max-w-[240px] mb-4" src="https://i.imgur.com/EnuWGLA.png" alt="Lip Sync Header">
    <div id="login-options" class="w-full flex-1">
      <div id="student-id-mode">
        <p id="student-id-error" class="text-white/70 text-base mb-6">Enter your Student ID to vote.</p>
        <input type="number" id="student-id-input" placeholder="Enter Student ID"
          class="w-full p-3 rounded-lg bg-white/10 text-white border border-white/30 text-center mb-3 text-base"/>
        <button id="student-id-btn" class="glow w-auto min-w-[180px] px-8 py-3 text-base text-white rounded-xl border border-white/50 shadow-lg transition mb-4">Verify ID</button>
        <a href="#" id="show-location-mode" class="block text-sm text-white/60 underline mt-2 mb-4 py-2 hover:text-white/90 transition">
          Can’t use Student ID? Vote with location instead.
        </a>
      </div>
      <div id="location-mode" class="hidden">
        <p id="location-error" class="text-white/70 text-base mb-6">Location access is required to vote.</p>
        <button id="location-btn" class="glow w-auto min-w-[180px] px-8 py-3 text-base text-white rounded-xl border border-white/50 shadow-lg transition mb-4">Begin Voting</button>
        <a href="#" id="show-id-mode" class="block text-sm text-white/60 underline mt-2 mb-4 py-2 hover:text-white/90 transition">
          Vote with Student ID instead.
        </a>
      </div>
    </div>
    <footer class="pt-6 text-white/70 text-sm flex flex-col items-center max-w-sm mt-4 mb-2">
      <img src="https://ik.imagekit.io/cabgcu/Untitled%20design-3.png" alt="CAB Logo" class="h-10 mb-2 object-contain" onerror="this.style.display='none'">
      <p>Follow Us At <b>@CABGCU</b> On Instagram</p>
    </footer>
  </div>
</div>

<!-- VOTING -->
<div id="voting-screen" class="screen hidden">
  <div class="glass-card w-full max-w-md text-center shadow-2xl">
    <img class="w-full max-w-[180px] mx-auto mb-3 mt-5" src="https://i.imgur.com/EnuWGLA.png" alt="Header">
    <h3 id="voting-header" class="text-xl font-semibold mb-2">Vote For Your Favorite Lip Sync Team!</h3>
    <p id="voting-subtext" class="text-white/70 text-sm mb-4">Each attendee may submit only one vote per device or Student ID.</p>

    <div id="performers-container" class="space-y-3">
      <!-- dynamically filled -->
    </div>

    <button id="submit-vote-btn"
      class="mt-5 mb-5 w-full py-3 px-6 text-base bg-black border border-white/50 text-white rounded-xl transition disabled:opacity-40"
      disabled>Select a Performer to Vote</button>
  </div>
</div>

<!-- CONFIRMATION -->
<div id="confirmation-screen" class="screen hidden">
  <div class="glass-card w-11/12 max-w-sm rounded-3xl p-6 text-center shadow-2xl">
    <h3 class="text-2xl font-bold mb-3 text-white">✅ Submission Received!</h3>
    <img id="confirmation-image" class="w-full max-w-[240px] mx-auto rounded-xl mb-4" alt="Team Image">
    <p id="confirmation-message" class="text-white text-base mb-4"></p>
  </div>
</div>

<!-- Firebase + JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";

const firebaseConfig={apiKey:"AIzaSyBoYf1_IhILJ96Y9KMcwrVjHMFLT5YEKuQ",authDomain:"lip-sync-2025.firebaseapp.com",projectId:"lip-sync-2025",storageBucket:"lip-sync-2025.appspot.com",messagingSenderId:"118581305479",appId:"1:118581305479:web:7a7335c1be6e816cc7d822",measurementId:"G-NQ0GMG05Q2"};

let db,auth,userId,deviceHash=null;
let selectedVoteId=null,selectedVoteName="",selectedVoteImage="";
let appInitialized=false,votingEnabled=true,authMethod=null,verifiedStudentId=null;

const performerData={
  option1:{name:"Below",img:"https://i.imgur.com/DIyK2zX.jpeg"},
  option2:{name:"Deliverance",img:"https://i.imgur.com/s7Unz9r.jpeg"},
  option3:{name:"Mask Off",img:"https://i.imgur.com/x0BI8Mc.jpeg"},
  option4:{name:"Metro Motion",img:"https://i.imgur.com/4rG47gL.jpeg"},
  option5:{name:"Sin Game",img:"https://i.imgur.com/k75mMUz.jpeg"},
  option6:{name:"Anonymity",img:"https://i.imgur.com/3dJQFeX.jpeg"}
};

function setScreen(id){document.querySelectorAll(".screen").forEach(el=>el.classList.add("hidden"));document.getElementById(id).classList.remove("hidden");}
function showError(msg,type='location'){const el=(type==='location')?document.getElementById("location-error"):document.getElementById("student-id-error");el.textContent=msg;el.classList.add("text-red-400","font-bold");}

async function initializeFirebase(){
  const app=initializeApp(firebaseConfig);
  initializeAppCheck(app,{provider:new ReCaptchaV3Provider('6LdIDf8rAAAAAN29EDUYVkddlpw3QQy9ImSPFpm1'),isTokenAutoRefreshEnabled:true});
  db=getFirestore(app);auth=getAuth(app);
  initializeAppLogic();
}

async function generateDeviceHash(){
  const fp=await FingerprintJS.load();const r=await fp.get();
  const traits=[navigator.userAgent,navigator.language,screen.width,screen.height,navigator.hardwareConcurrency,Intl.DateTimeFormat().resolvedOptions().timeZone,r.components.platform?.value||"",r.components.vendor?.value||""].join("|");
  const buf=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(traits));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

async function restoreVoteIfExists(){
  if(!userId||!db)return;
  try{
    const s=await getDoc(doc(db,"lip_sync_2025_votes",userId));
    if(s.exists()){
      const v=s.data().voteId;const p=performerData[v];
      document.getElementById("confirmation-image").src=p.img;
      document.getElementById("confirmation-message").innerHTML=`Your vote for <b>${p.name}</b> has been recorded.<br><br>Thank you for attending <b>Lip Sync: For Good!</b>`;
      setScreen("confirmation-screen");
    }else setScreen("login-screen");
  }catch{setScreen("login-screen");}
}

function handleCardSelection(e){
  const c=e.target.closest(".performer-card");if(!c)return;
  document.querySelectorAll(".performer-card").forEach(x=>x.classList.remove("selected"));
  c.classList.add("selected");
  selectedVoteId=c.dataset.voteId;
  selectedVoteName=performerData[selectedVoteId].name;
  selectedVoteImage=performerData[selectedVoteId].img;
  const b=document.getElementById("submit-vote-btn");
  b.disabled=false;b.textContent=`Submit Vote for ${selectedVoteName}`;b.classList.add("ready");
}

async function submitVote(voteId,btn){
  btn.disabled=true;btn.textContent="Submitting...";
  setTimeout(()=>{document.getElementById("confirmation-image").src=performerData[voteId].img;
  document.getElementById("confirmation-message").innerHTML=`Your vote for <b>${performerData[voteId].name}</b> has been recorded.<br><br>Thank you for attending <b>Lip Sync: For Good!</b>`;
  setScreen("confirmation-screen");},800);
}

function handleLocationCheck(){
  setScreen("voting-screen");
}

async function handleStudentIdCheck(){
  const id=document.getElementById("student-id-input").value;
  if(!id)return showError("Please enter a Student ID.",'student_id');
  setScreen("voting-screen");
}

async function initializeAppLogic(){
  if(appInitialized)return;appInitialized=true;
  document.getElementById("location-btn").addEventListener("click",handleLocationCheck);
  document.getElementById("performers-container").addEventListener("click",handleCardSelection);
  document.getElementById("submit-vote-btn").addEventListener("click",()=>submitVote(selectedVoteId,document.getElementById("submit-vote-btn")));
  document.getElementById("student-id-btn").addEventListener("click",handleStudentIdCheck);
  document.getElementById("show-id-mode").addEventListener("click",e=>{e.preventDefault();document.getElementById("location-mode").classList.add("hidden");document.getElementById("student-id-mode").classList.remove("hidden");});
  document.getElementById("show-location-mode").addEventListener("click",e=>{e.preventDefault();document.getElementById("student-id-mode").classList.add("hidden");document.getElementById("location-mode").classList.remove("hidden");});

  const cont=document.getElementById("performers-container");
  cont.innerHTML=Object.entries(performerData).map(([id,{name,img}])=>
    `<div class="performer-card bg-white/5 border border-white/10 p-4 rounded-xl cursor-pointer" data-vote-id="${id}">
      <img src="${img}" class="w-full aspect-video object-cover rounded-lg mb-2" alt="${name}">
      <h4 class="text-lg font-semibold">${name}</h4>
    </div>`).join('');
}
document.addEventListener("DOMContentLoaded",()=>initializeFirebase());
</script>
</body>
</html>
